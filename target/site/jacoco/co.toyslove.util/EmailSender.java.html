<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>EmailSender.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ToysLove</a> &gt; <a href="index.source.html" class="el_package">co.toyslove.util</a> &gt; <span class="el_source">EmailSender.java</span></div><h1>EmailSender.java</h1><pre class="source lang-java linenums">package co.toyslove.util;

import java.text.NumberFormat;
import java.util.List;

import javax.annotation.Resource;
import javax.mail.MessagingException;
import javax.mail.internet.MimeMessage;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.mail.SimpleMailMessage;
import org.springframework.mail.javamail.JavaMailSender;
import org.springframework.mail.javamail.MimeMessageHelper;
import org.springframework.stereotype.Component;

import co.toyslove.entity.Client;
import co.toyslove.model.ShoppingCart;
import co.toyslove.model.ShoppingItem;

@Component
<span class="nc" id="L22">public class EmailSender {</span>
	@Autowired
	JavaMailSender sender;
	
	@Autowired
	TemplateReader templateReader;
	
	@Autowired
	@Qualifier(&quot;currencyFormat&quot;)
	NumberFormat currencyFormat;
	
	public void sendCheckoutOrder(ShoppingCart shoppingCart){
		//SimpleMailMessage message = new SimpleMailMessage();
<span class="nc" id="L35">		MimeMessage createMimeMessage = sender.createMimeMessage();</span>
		try {
<span class="nc" id="L37">			MimeMessageHelper helper = new MimeMessageHelper(createMimeMessage, true);</span>
<span class="nc" id="L38">			helper.setTo(new String[] {&quot;danielgm9312@hotmail.com&quot;,shoppingCart.getClient().getEmail()});</span>
<span class="nc" id="L39">			helper.setSubject(&quot;Orden de compra&quot;);</span>
<span class="nc" id="L40">			helper.setText(getHTMLBodyOrder(shoppingCart),true);</span>
<span class="nc" id="L41">			sender.send(createMimeMessage);</span>
<span class="nc" id="L42">		} catch (MessagingException e) {</span>
<span class="nc" id="L43">			e.printStackTrace();</span>
<span class="nc" id="L44">		}</span>
		
		
<span class="nc" id="L47">	}</span>
	
	private String getHTMLBodyOrder(ShoppingCart shoppingCart) {
		
<span class="nc" id="L51">		String base = templateReader.getTemplate(&quot;PurchaseOrder&quot;);</span>
<span class="nc" id="L52">		String table = &quot;&quot;;</span>
<span class="nc" id="L53">		table+=&quot;&lt;table border=0&gt;&quot;;</span>
<span class="nc" id="L54">		table+=	&quot;&lt;tr&gt;&quot;;</span>
<span class="nc" id="L55">		table+=	 &quot;&lt;th&gt;Producto&lt;/th&gt;&quot;;</span>
<span class="nc" id="L56">		table+=	 &quot;&lt;th&gt;Valor&lt;/th&gt;&quot;;</span>
<span class="nc" id="L57">		table+=	 &quot;&lt;th&gt;Cantidad&lt;/th&gt;&quot;;</span>
<span class="nc" id="L58">		table+=	 &quot;&lt;th&gt;Total&lt;/th&gt;&quot;;</span>
<span class="nc" id="L59">		table+=	&quot;&lt;/tr&gt;&quot;;</span>
<span class="nc" id="L60">		table+=getItemsDetails(shoppingCart.getShoppingItems());</span>
		
<span class="nc" id="L62">		table+=&quot;&lt;tr&gt;&lt;td colspan=3&gt;Total&lt;/td&gt;&lt;td&gt;&quot;+currencyFormat.format(getTotal(shoppingCart.getShoppingItems()))+&quot;&lt;/td&gt;&lt;/tr&gt;&quot;;</span>
<span class="nc" id="L63">		table+=&quot;&lt;/table&gt;&quot;;</span>
<span class="nc" id="L64">		table+=getClentInfo(shoppingCart.getClient());</span>
<span class="nc" id="L65">		String bodyEmail = String.format(base, table);</span>
<span class="nc" id="L66">		System.out.println(bodyEmail);</span>
<span class="nc" id="L67">		return bodyEmail;</span>
	}

	private String getClentInfo(Client client) {
<span class="nc" id="L71">		String body = &quot;&quot;;</span>
<span class="nc" id="L72">		body+=&quot;&lt;h3&gt;Informaciï¿½n de cliente&lt;/h3&gt;&quot;;</span>
<span class="nc" id="L73">		body+=&quot;&lt;label&gt;&quot;+client.getName()+&quot; &quot;+client.getLastName()+&quot;&lt;/label&gt;&lt;br/&gt;&quot;;</span>
<span class="nc" id="L74">		body+=&quot;&lt;label&gt;&quot;+client.getEmail()+&quot;&lt;/label&gt;&lt;br/&gt;&quot;;</span>
<span class="nc" id="L75">		body+=&quot;&lt;label&gt;&quot;+client.getPhone()+&quot;&lt;/label&gt;&lt;br/&gt;&quot;;</span>
<span class="nc" id="L76">		body+=&quot;&lt;label&gt;&quot;+client.getAddress()+&quot; - &quot;+client.getAddressAppend()+&quot;&lt;/label&gt;&lt;br/&gt;&quot;;</span>
<span class="nc" id="L77">		body+=&quot;&lt;label&gt;&quot;+client.getAddressComment()+&quot;&lt;/label&gt;&lt;br/&gt;&quot;;</span>
<span class="nc" id="L78">		body+=&quot;&lt;label&gt;&quot;+client.getCity()+&quot;&lt;/label&gt;&lt;br/&gt;&quot;;</span>
<span class="nc" id="L79">		body+=&quot;&lt;label&gt;Antioquia&lt;/label&gt;&lt;br/&gt;&quot;; //TODO Cargar estado de BD</span>
<span class="nc" id="L80">		return body;</span>
	}

	private int getTotal(List&lt;ShoppingItem&gt; shoppingItems) {
<span class="nc" id="L84">		return shoppingItems.stream().mapToInt(item-&gt;item.getProduct().getValue()*item.getCount()).sum();</span>
	}

	private String getItemsDetails(List&lt;ShoppingItem&gt; shoppingItems) {
<span class="nc" id="L88">		String body = shoppingItems.stream().map(item-&gt;{</span>
<span class="nc" id="L89">			String details = &quot;&lt;tr&gt;&quot;;</span>
<span class="nc" id="L90">			details+=	&quot;&lt;td&gt;&quot;+item.getProduct().getName()+&quot;&lt;/td&gt;&quot;;</span>
<span class="nc" id="L91">			details+=	&quot;&lt;td&gt;&quot;+currencyFormat.format(item.getProduct().getValue())+&quot;&lt;/td&gt;&quot;;</span>
<span class="nc" id="L92">			details+=	&quot;&lt;td&gt;&quot;+item.getCount()+&quot;&lt;/td&gt;&quot;;</span>
<span class="nc" id="L93">			details+=	&quot;&lt;td&gt;&quot;+currencyFormat.format((long)item.getCount()*item.getProduct().getValue())+&quot;&lt;/td&gt;&quot;;</span>
<span class="nc" id="L94">			details+=&quot;&lt;/tr&gt;&quot;;</span>
<span class="nc" id="L95">			return details;</span>
<span class="nc" id="L96">		}).reduce(&quot;&quot;, String::concat);</span>
				
<span class="nc" id="L98">		return body;</span>
	}

	public void sendTest() {
<span class="nc" id="L102">		System.out.println(templateReader.getTemplate(&quot;PurchaseOrder&quot;));</span>
		
<span class="nc" id="L104">		SimpleMailMessage message = new SimpleMailMessage();</span>
<span class="nc" id="L105">		message.setTo(&quot;danielgm9312@hotmail.com&quot;);</span>
<span class="nc" id="L106">		message.setSubject(&quot;Prueba tienda&quot;);</span>
<span class="nc" id="L107">		message.setText(&quot;Mensaje de prueba&quot;);</span>
<span class="nc" id="L108">		sender.send(message);</span>

<span class="nc" id="L110">	}</span>
	
	
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>